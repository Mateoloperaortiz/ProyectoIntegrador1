{% extends 'base.html' %}
{% load static %}
{% load catalog_extras %}
{% load humanize %}

{% block title %}{% if ai_tool %}Chat with {{ ai_tool.name }}{% else %}Chat{% endif %} | InspireAI{% endblock %}

{% block extra_css %}
<style>
  /* Core layout styles */
  .chat-layout {
    display: flex;
    height: calc(100vh - 60px);
    overflow: hidden;
  }
  
  .sidebar {
    width: 260px;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #e5e7eb;
    background-color: #f9fafb;
    transition: all 0.3s ease;
    z-index: 100;
  }
  
  .sidebar-collapsed {
    width: 0;
    padding: 0;
    border-right: none;
  }
  
  .main-chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }
  
  .mobile-nav {
    display: none;
    padding: 0.75rem 1rem;
    background-color: white;
    border-bottom: 1px solid #e5e7eb;
    position: relative;
    z-index: 50;
  }
  
  /* Chat container styling */
  .chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background-color: white;
    scrollbar-width: thin;
    scrollbar-color: #e5e7eb #f3f4f6;
  }
  
  .chat-container::-webkit-scrollbar {
    width: 6px;
  }
  
  .chat-container::-webkit-scrollbar-track {
    background: #f9fafb;
  }
  
  .chat-container::-webkit-scrollbar-thumb {
    background-color: #d1d5db;
    border-radius: 10px;
  }
  
  /* Model selector section */
  .models-section {
    margin-bottom: 1.5rem;
    padding: 0 1rem;
  }
  
  .model-category {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    color: #6b7280;
    margin-bottom: 0.5rem;
    padding-left: 0.5rem;
    letter-spacing: 0.05em;
  }
  
  .model-list {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }
  
  .model-item {
    display: flex;
    align-items: center;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .model-item:hover {
    background-color: #f3f4f6;
  }
  
  .model-item.active {
    background-color: #eff6ff;
    color: #1d4ed8;
  }
  
  .model-item img {
    width: 22px;
    height: 22px;
    border-radius: 4px;
    margin-right: 0.75rem;
    object-fit: cover;
  }
  
  .model-name {
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  /* Messages styling */
  .message-container {
    margin-bottom: 1.5rem;
    animation: fadeIn 0.3s ease-out;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .message-header {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  
  .message-avatar {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    margin-right: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f3f4f6;
    color: #4b5563;
    font-weight: 600;
    font-size: 14px;
    overflow: hidden;
  }
  
  .message-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .user-message .message-avatar {
    background-color: #e0f2fe;
    color: #0369a1;
  }
  
  .ai-message .message-avatar {
    background-color: #f9fafb;
    color: #374151;
  }
  
  .message-sender {
    font-size: 0.875rem;
    font-weight: 600;
    color: #111827;
  }
  
  .message-content {
    padding-left: calc(28px + 0.75rem);
    font-size: 0.9375rem;
    line-height: 1.6;
    color: #111827;
    white-space: pre-wrap;
  }
  
  .message-content p {
    margin-bottom: 0.75rem;
  }
  
  .message-content p:last-child {
    margin-bottom: 0;
  }
  
  .message-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 0.75rem;
    padding-left: calc(28px + 0.75rem);
    gap: 0.5rem;
  }
  
  .message-action-button {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    background-color: transparent;
    color: #6b7280;
    border: none;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .message-action-button:hover {
    background-color: #f3f4f6;
    color: #4b5563;
  }
  
  .message-action-button i {
    margin-right: 0.25rem;
    font-size: 0.8125rem;
  }
  
  /* Chat input styling */
  .chat-input-container {
    padding: 1rem;
    border-top: 1px solid #e5e7eb;
    background-color: white;
  }
  
  .chat-form {
    position: relative;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.5rem;
    background-color: white;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    transition: all 0.2s ease;
  }
  
  .chat-form:focus-within {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
  }
  
  .chat-input {
    width: 100%;
    min-height: 48px;
    max-height: 200px;
    border: none;
    padding: 0.75rem 40px 0.75rem 0.75rem;
    resize: none;
    font-size: 0.9375rem;
    line-height: 1.5;
    background-color: transparent;
    outline: none;
    overflow-y: auto;
  }
  
  .send-button {
    position: absolute;
    bottom: 0.75rem;
    right: 0.75rem;
    width: 28px;
    height: 28px;
    border-radius: 6px;
    background-color: #3b82f6;
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    cursor: pointer;
  }
  
  .send-button:hover {
    background-color: #2563eb;
  }
  
  .send-button:disabled {
    background-color: #d1d5db;
    cursor: not-allowed;
  }
  
  /* Sidebar conversations */
  .conversations-section {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    padding: 0 1rem;
  }
  
  .conversation-item {
    display: flex;
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
  }
  
  .conversation-item:hover {
    background-color: #f3f4f6;
  }
  
  .conversation-item.active {
    background-color: #eff6ff;
    color: #1d4ed8;
  }
  
  .conversation-icon {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    font-size: 14px;
    color: #4b5563;
    background-color: #f3f4f6;
  }
  
  .conversation-item.active .conversation-icon {
    color: #1d4ed8;
    background-color: #dbeafe;
  }
  
  .conversation-title {
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 0.25rem;
  }
  
  .conversation-date {
    font-size: 0.75rem;
    color: #6b7280;
  }
  
  .conversation-item.active .conversation-date {
    color: #3b82f6;
  }
  
  /* Empty state */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 2rem;
    color: #6b7280;
    text-align: center;
  }
  
  .empty-state-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f3f4f6;
    margin-bottom: 1.5rem;
    color: #4b5563;
  }
  
  .empty-state h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: #111827;
  }
  
  .empty-state p {
    max-width: 400px;
    line-height: 1.6;
  }
  
  /* Header actions */
  .sidebar-header,
  .chat-header {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    background-color: white;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .header-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #111827;
  }
  
  .sidebar-actions,
  .header-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .action-button {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    background-color: transparent;
    color: #4b5563;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .action-button:hover {
    background-color: #f3f4f6;
    color: #111827;
  }
  
  /* New chat button */
  .new-chat-button {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem;
    background-color: #3b82f6;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    margin: 1rem;
    transition: all 0.2s ease;
  }
  
  .new-chat-button:hover {
    background-color: #2563eb;
  }
  
  .new-chat-button i {
    margin-right: 0.5rem;
  }
  
  /* Model info card */
  .model-info-card {
    padding: 1rem;
    border-radius: 8px;
    background-color: #f9fafb;
    margin: 1rem;
    animation: fadeIn 0.5s ease-out;
  }
  
  .model-info-header {
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
  }
  
  .model-info-header img {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    margin-right: 0.75rem;
    object-fit: cover;
  }
  
  .model-info-name {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #111827;
  }
  
  .model-info-provider {
    font-size: 0.75rem;
    color: #6b7280;
  }
  
  .model-info-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-top: 0.75rem;
  }
  
  .model-stat {
    display: flex;
    flex-direction: column;
  }
  
  .model-stat-value {
    font-size: 0.875rem;
    font-weight: 600;
    color: #111827;
  }
  
  .model-stat-label {
    font-size: 0.75rem;
    color: #6b7280;
  }
  
  /* Response streaming effect */
  .typing-animation::after {
    content: 'â–‹';
    display: inline-block;
    color: #6b7280;
    animation: blink 1s step-end infinite;
  }
  
  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }
  
  /* Mobile styles */
  @media (max-width: 768px) {
    .chat-layout {
      height: calc(100vh - 100px);
    }
    
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 80%;
      max-width: 300px;
      z-index: 100;
      transform: translateX(-100%);
    }
    
    .sidebar.open {
      transform: translateX(0);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    
    .main-chat {
      width: 100%;
    }
    
    .mobile-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .message-content {
      padding-left: 0;
      margin-top: 0.5rem;
    }
    
    .message-actions {
      padding-left: 0;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="chat-layout">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="header-title">InspireAI Chat</div>
      <div class="sidebar-actions">
        <button class="action-button d-md-none" id="close-sidebar">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    
    <button class="new-chat-button" id="new-chat-btn">
      <i class="fas fa-plus"></i> New Chat
    </button>
    
    <!-- Model Categories -->
    <div class="models-section">
      <div class="model-category">Flagship Models</div>
      <div class="model-list">
        {% for model in flagship_models %}
          <div class="model-item {% if ai_tool and ai_tool.id == model.id %}active{% endif %}" data-model-id="{{ model.id }}">
            {% if model.image %}
              <img src="{{ model.image.url }}" alt="{{ model.name }}">
            {% else %}
              <div class="message-avatar">{{ model.name|slice:":1"|upper }}</div>
            {% endif %}
            <div class="model-name">{{ model.name }}</div>
          </div>
        {% endfor %}
      </div>
    </div>
    
    <div class="models-section">
      <div class="model-category">Coding Specialists</div>
      <div class="model-list">
        {% for model in coding_models %}
          <div class="model-item {% if ai_tool and ai_tool.id == model.id %}active{% endif %}" data-model-id="{{ model.id }}">
            {% if model.image %}
              <img src="{{ model.image.url }}" alt="{{ model.name }}">
            {% else %}
              <div class="message-avatar">{{ model.name|slice:":1"|upper }}</div>
            {% endif %}
            <div class="model-name">{{ model.name }}</div>
          </div>
        {% endfor %}
      </div>
    </div>
    
    <div class="models-section">
      <div class="model-category">Reasoning & Logic</div>
      <div class="model-list">
        {% for model in reasoning_models %}
          <div class="model-item {% if ai_tool and ai_tool.id == model.id %}active{% endif %}" data-model-id="{{ model.id }}">
            {% if model.image %}
              <img src="{{ model.image.url }}" alt="{{ model.name }}">
            {% else %}
              <div class="message-avatar">{{ model.name|slice:":1"|upper }}</div>
            {% endif %}
            <div class="model-name">{{ model.name }}</div>
          </div>
        {% endfor %}
      </div>
    </div>
    
    <!-- Conversations -->
    {% if user.is_authenticated and user_conversations %}
    <div class="models-section">
      <div class="model-category">Recent Conversations</div>
      <div class="conversations-section">
        {% for conv in user_conversations|slice:":10" %}
          <div class="conversation-item {% if conversation and conv.id == conversation.id %}active{% endif %}" data-conversation-id="{{ conv.id }}">
            <div class="conversation-icon">
              <i class="fas fa-message"></i>
            </div>
            <div>
              <div class="conversation-title">{{ conv.title|truncatechars:25 }}</div>
              <div class="conversation-date">{{ conv.updated_at|date:"M d, Y" }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
  
  <!-- Main Chat Area -->
  <div class="main-chat">
    <!-- Mobile Navigation -->
    <div class="mobile-nav">
      <button class="action-button" id="open-sidebar">
        <i class="fas fa-bars"></i>
      </button>
      <div class="header-title">InspireAI Chat</div>
      <div></div>
    </div>
    
    <!-- Chat Header -->
    {% if ai_tool %}
    <div class="chat-header">
      <div class="d-flex align-items-center">
        {% if ai_tool.image %}
          <img src="{{ ai_tool.image.url }}" alt="{{ ai_tool.name }}" class="message-avatar">
        {% else %}
          <div class="message-avatar">{{ ai_tool.name|slice:":1"|upper }}</div>
        {% endif %}
        <div class="ms-2">
          <div class="model-info-name">{{ ai_tool.name }}</div>
          <div class="model-info-provider">{{ ai_tool.provider }}</div>
        </div>
      </div>
      
      <div class="header-actions">
        <button class="action-button" id="chat-info-btn" title="Model Info">
          <i class="fas fa-info-circle"></i>
        </button>
        <div class="dropdown">
          <button class="action-button" type="button" id="chatOptionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-ellipsis-vertical"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0" aria-labelledby="chatOptionsDropdown">
            <li><a class="dropdown-item" href="#" id="clearChat"><i class="fas fa-eraser me-2 text-danger"></i>Clear Chat</a></li>
            {% if conversation %}
            <li><a class="dropdown-item" href="{% url 'download_conversation' conversation.id 'txt' %}"><i class="fas fa-file-alt me-2 text-primary"></i>Download as Text</a></li>
            <li><a class="dropdown-item" href="{% url 'download_conversation' conversation.id 'json' %}"><i class="fas fa-file-code me-2 text-secondary"></i>Download as JSON</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" id="shareLink"><i class="fas fa-share-alt me-2 text-success"></i>Share Conversation</a></li>
            {% else %}
            <li><a class="dropdown-item disabled" href="#"><i class="fas fa-file-alt me-2 text-primary"></i>Download as Text</a></li>
            <li><a class="dropdown-item disabled" href="#"><i class="fas fa-file-code me-2 text-secondary"></i>Download as JSON</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item disabled" href="#"><i class="fas fa-share-alt me-2 text-success"></i>Share Conversation</a></li>
            {% endif %}
          </ul>
        </div>
      </div>
    </div>
    {% endif %}
    
    <!-- Model Info Card (hidden by default) -->
    {% if ai_tool %}
    <div class="model-info-card" id="model-info-card" style="display: none;">
      <div class="model-info-header">
        {% if ai_tool.image %}
          <img src="{{ ai_tool.image.url }}" alt="{{ ai_tool.name }}">
        {% else %}
          <div class="message-avatar">{{ ai_tool.name|slice:":1"|upper }}</div>
        {% endif %}
        <div>
          <div class="model-info-name">{{ ai_tool.name }}</div>
          <div class="model-info-provider">{{ ai_tool.provider }}</div>
        </div>
      </div>
      
      <div class="model-description">
        {{ ai_tool.description|truncatechars:200 }}
      </div>
      
      <div class="model-info-stats">
        <div class="model-stat">
          <div class="model-stat-value">{{ ai_tool.context_length|intcomma }}</div>
          <div class="model-stat-label">Context Length</div>
        </div>
        <div class="model-stat">
          <div class="model-stat-value">${{ ai_tool.prompt_pricing }}</div>
          <div class="model-stat-label">Per 1M tokens</div>
        </div>
        <div class="model-stat">
          <div class="model-stat-value">{{ ai_tool.get_modality_display }}</div>
          <div class="model-stat-label">Modality</div>
        </div>
        <div class="model-stat">
          <div class="model-stat-value">{{ ai_tool.latency }}ms</div>
          <div class="model-stat-label">Avg. Latency</div>
        </div>
      </div>
    </div>
    {% endif %}
    
    <!-- Chat Messages -->
    <div id="chat-messages" class="chat-container">
      {% if not messages %}
        <div class="empty-state">
          <div class="empty-state-icon">
            <i class="fas fa-robot fa-2x"></i>
          </div>
          <h3>Start the conversation</h3>
          {% if ai_tool %}
            <p>Chat with {{ ai_tool.name }} by typing a message below.</p>
          {% else %}
            <p>Select an AI model from the sidebar or start a new conversation.</p>
          {% endif %}
        </div>
      {% else %}
        {% for message in messages %}
          <div class="message-container {% if message.is_user %}user-message{% else %}ai-message{% endif %}">
            <div class="message-header">
              <div class="message-avatar">
                {% if message.is_user %}
                  {{ request.user.username|slice:":1"|upper }}
                {% else %}
                  {% if ai_tool.image %}
                    <img src="{{ ai_tool.image.url }}" alt="{{ ai_tool.name }}">
                  {% else %}
                    {{ ai_tool.name|slice:":1"|upper }}
                  {% endif %}
                {% endif %}
              </div>
              <div class="message-sender">
                {% if message.is_user %}You{% else %}{{ ai_tool.name }}{% endif %}
              </div>
            </div>
            <div class="message-content">{{ message.content|linebreaks }}</div>
            <div class="message-actions">
              <button class="message-action-button copy-message" data-content="{{ message.content }}">
                <i class="fas fa-copy"></i> Copy
              </button>
              {% if not message.is_user %}
              <button class="message-action-button regenerate-message" data-message-id="{{ message.id }}">
                <i class="fas fa-sync-alt"></i> Regenerate
              </button>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>
    
    <!-- Chat Input -->
    <div class="chat-input-container">
      <form id="chat-form">
        <div class="chat-form">
          <textarea id="message-input" class="chat-input" placeholder="Type your message here..." rows="1" required></textarea>
          <button type="submit" class="send-button" id="send-button" disabled>
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </form>
      <div class="d-flex align-items-center justify-content-center mt-2">
        <small class="text-muted">
          {% if has_api %}
            Connected to {{ ai_tool.get_api_type_display }}
            {% if ai_tool.api_model %} ({{ ai_tool.api_model }}){% endif %}
          {% else %}
            Demo Mode: API integration is not currently active.
          {% endif %}
        </small>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const sidebar = document.getElementById('sidebar');
    const openSidebarBtn = document.getElementById('open-sidebar');
    const closeSidebarBtn = document.getElementById('close-sidebar');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const chatMessages = document.getElementById('chat-messages');
    const clearChatBtn = document.getElementById('clearChat');
    const shareLink = document.getElementById('shareLink');
    const newChatBtn = document.getElementById('new-chat-btn');
    const modelItems = document.querySelectorAll('.model-item');
    const conversationItems = document.querySelectorAll('.conversation-item');
    const chatInfoBtn = document.getElementById('chat-info-btn');
    const modelInfoCard = document.getElementById('model-info-card');
    
    {% if conversation %}
    const conversationId = '{{ conversation.id }}';
    {% else %}
    const conversationId = '';
    {% endif %}
    
    // Enable/disable send button based on input
    messageInput.addEventListener('input', function() {
      sendButton.disabled = messageInput.value.trim() === '';
      
      // Auto resize textarea
      messageInput.style.height = 'auto';
      const newHeight = Math.min(messageInput.scrollHeight, 200);
      messageInput.style.height = newHeight + 'px';
    });
    
    // Mobile sidebar toggle
    if (openSidebarBtn) {
      openSidebarBtn.addEventListener('click', function() {
        sidebar.classList.add('open');
      });
    }
    
    if (closeSidebarBtn) {
      closeSidebarBtn.addEventListener('click', function() {
        sidebar.classList.remove('open');
      });
    }
    
    // Scroll to bottom of chat
    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Initially scroll to bottom
    scrollToBottom();
    
    // Format messages with code blocks, etc.
    function formatMessage(message) {
      // Replace code blocks (```code```) with formatted HTML
      let formattedMessage = message.replace(/```([\s\S]*?)```/g, '<pre class="bg-light p-3 rounded"><code>$1</code></pre>');
      
      // Replace inline code (`code`) with formatted HTML
      formattedMessage = formattedMessage.replace(/`([^`]+)`/g, '<code class="bg-light px-1 rounded">$1</code>');
      
      return formattedMessage;
    }
    
    // Send message function with streaming simulation
    async function sendMessage(message) {
      // Create user message element
      const userMessageContainer = document.createElement('div');
      userMessageContainer.className = 'message-container user-message';
      userMessageContainer.innerHTML = `
        <div class="message-header">
          <div class="message-avatar">
            {% if user.is_authenticated %}{{ user.username|slice:":1"|upper }}{% else %}G{% endif %}
          </div>
          <div class="message-sender">You</div>
        </div>
        <div class="message-content">${message.replace(/\n/g, '<br>')}</div>
        <div class="message-actions">
          <button class="message-action-button copy-message" data-content="${message}">
            <i class="fas fa-copy"></i> Copy
          </button>
        </div>
      `;
      
      // Create AI response container with typing animation
      const aiMessageContainer = document.createElement('div');
      aiMessageContainer.className = 'message-container ai-message';
      aiMessageContainer.innerHTML = `
        <div class="message-header">
          <div class="message-avatar">
            {% if ai_tool.image %}
              <img src="{{ ai_tool.image.url }}" alt="{{ ai_tool.name }}">
            {% else %}
              {{ ai_tool.name|slice:":1"|upper }}
            {% endif %}
          </div>
          <div class="message-sender">{{ ai_tool.name }}</div>
        </div>
        <div class="message-content typing-animation"></div>
      `;
      
      // Remove empty state if it exists
      const emptyState = chatMessages.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }
      
      // Add messages to chat
      chatMessages.appendChild(userMessageContainer);
      chatMessages.appendChild(aiMessageContainer);
      
      // Scroll to bottom
      scrollToBottom();
      
      try {
        // Send message to server
        const response = await fetch(`/chat/${conversationId}/send/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message }),
        });
        
        if (response.ok) {
          const data = await response.json();
          
          if (data.success) {
            // Get the typing animation element
            const typingElement = aiMessageContainer.querySelector('.typing-animation');
            
            // Simulate streaming response by revealing characters gradually
            const aiMessage = data.ai_message.content;
            const formattedMessage = formatMessage(aiMessage);
            
            // Remove typing animation class and add the first character
            typingElement.classList.remove('typing-animation');
            typingElement.innerHTML = '';
            
            let currentCharIndex = 0;
            const totalChars = formattedMessage.length;
            
            // Typing speed - adjust for faster/slower effect
            const typingInterval = Math.max(5, Math.min(20, 2000 / totalChars));
            
            // Function to add characters one by one
            function addNextChar() {
              if (currentCharIndex < totalChars) {
                typingElement.innerHTML += formattedMessage.charAt(currentCharIndex);
                currentCharIndex++;
                setTimeout(addNextChar, typingInterval);
                scrollToBottom();
              } else {
                // Done typing, add message actions
                const messageActions = document.createElement('div');
                messageActions.className = 'message-actions';
                messageActions.innerHTML = `
                  <button class="message-action-button copy-message" data-content="${aiMessage}">
                    <i class="fas fa-copy"></i> Copy
                  </button>
                  <button class="message-action-button regenerate-message" data-message-id="${data.ai_message.id}">
                    <i class="fas fa-sync-alt"></i> Regenerate
                  </button>
                `;
                
                aiMessageContainer.appendChild(messageActions);
                
                // Add event listeners to the copy and regenerate buttons
                setupMessageActionButtons();
              }
            }
            
            // Start the typing animation
            setTimeout(addNextChar, 500); // Small delay before starting
          } else {
            // Show error
            aiMessageContainer.querySelector('.message-content').innerHTML = 
              `<div class="text-danger"><i class="fas fa-exclamation-circle me-2"></i>${data.error || 'Error processing your message'}</div>`;
            aiMessageContainer.querySelector('.message-content').classList.remove('typing-animation');
          }
        } else {
          // Show error
          aiMessageContainer.querySelector('.message-content').innerHTML = 
            `<div class="text-danger"><i class="fas fa-exclamation-circle me-2"></i>Error connecting to server</div>`;
          aiMessageContainer.querySelector('.message-content').classList.remove('typing-animation');
        }
      } catch (error) {
        // Show error
        aiMessageContainer.querySelector('.message-content').innerHTML = 
          `<div class="text-danger"><i class="fas fa-exclamation-circle me-2"></i>Error: ${error.message}</div>`;
        aiMessageContainer.querySelector('.message-content').classList.remove('typing-animation');
      }
    }
    
    // Setup message action buttons
    function setupMessageActionButtons() {
      // Copy message button
      document.querySelectorAll('.copy-message').forEach(button => {
        button.addEventListener('click', function() {
          const content = this.getAttribute('data-content');
          navigator.clipboard.writeText(content).then(() => {
            // Change button text temporarily to show success
            const originalHTML = this.innerHTML;
            this.innerHTML = '<i class="fas fa-check"></i> Copied';
            setTimeout(() => {
              this.innerHTML = originalHTML;
            }, 2000);
          });
        });
      });
      
      // Regenerate message button
      document.querySelectorAll('.regenerate-message').forEach(button => {
        button.addEventListener('click', function() {
          // Logic for regenerating responses would go here
          alert('Regenerate response feature coming soon!');
        });
      });
    }
    
    // Setup initial message action buttons
    setupMessageActionButtons();
    
    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const message = messageInput.value.trim();
      
      if (message) {
        sendMessage(message);
        messageInput.value = '';
        messageInput.style.height = 'auto';
        sendButton.disabled = true;
      }
    });
    
    // Clear chat button
    if (clearChatBtn) {
      clearChatBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (confirm('Are you sure you want to clear this chat? This cannot be undone.')) {
          // Clear the chat UI
          chatMessages.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">
                <i class="fas fa-robot fa-2x"></i>
              </div>
              <h3>Start the conversation</h3>
              {% if ai_tool %}
                <p>Chat with {{ ai_tool.name }} by typing a message below.</p>
              {% else %}
                <p>Select an AI model from the sidebar or start a new conversation.</p>
              {% endif %}
            </div>
          `;
        }
      });
    }
    
    // Share Link button
    if (shareLink) {
      shareLink.addEventListener('click', function(e) {
        e.preventDefault();
        
        {% if conversation and ai_tool %}
        const shareableLink = `${window.location.origin}/chat/{{ ai_tool.id }}?conversation_id={{ conversation.id }}`;
        
        // Copy to clipboard
        navigator.clipboard.writeText(shareableLink).then(function() {
          alert('Conversation link copied to clipboard!');
        }).catch(function() {
          alert('Failed to copy link');
        });
        {% else %}
        alert('No conversation to share');
        {% endif %}
      });
    }
    
    // New chat button
    if (newChatBtn) {
      newChatBtn.addEventListener('click', function() {
        {% if ai_tool %}
        window.location.href = `/chat/{{ ai_tool.id }}`;
        {% else %}
        alert('Please select an AI model first');
        {% endif %}
      });
    }
    
    // Model selection
    modelItems.forEach(item => {
      item.addEventListener('click', function() {
        const modelId = this.getAttribute('data-model-id');
        window.location.href = `/chat/${modelId}`;
      });
    });
    
    // Conversation selection
    conversationItems.forEach(item => {
      item.addEventListener('click', function() {
        const conversationId = this.getAttribute('data-conversation-id');
        window.location.href = `/chat/?conversation_id=${conversationId}`;
      });
    });
    
    // Chat info button
    if (chatInfoBtn && modelInfoCard) {
      chatInfoBtn.addEventListener('click', function() {
        if (modelInfoCard.style.display === 'none') {
          modelInfoCard.style.display = 'block';
        } else {
          modelInfoCard.style.display = 'none';
        }
      });
    }
    
    // Handle keyboard shortcuts
    messageInput.addEventListener('keydown', function(e) {
      // Submit with Enter (but allow Shift+Enter for new lines)
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!sendButton.disabled) {
          chatForm.dispatchEvent(new Event('submit'));
        }
      }
    });
    
    // Focus on input field by default
    messageInput.focus();
  });
</script>
{% endblock %}