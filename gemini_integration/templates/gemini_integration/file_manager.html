{% extends 'base.html' %}
{% load static %}

{% block title %}Gemini File Manager{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Gemini File Manager</h5>
                    <button type="button" class="btn btn-light btn-sm" id="refresh-files">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <!-- File Upload Form -->
                    <div class="mb-4">
                        <h6 class="card-subtitle mb-3">Upload a New File</h6>
                        <form id="file-upload-form" enctype="multipart/form-data">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <input type="file" class="form-control" id="file-input" name="file" required>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="purpose-select" name="purpose">
                                        <option value="general">General Use</option>
                                        <option value="vision">Vision</option>
                                        <option value="document">Document Analysis</option>
                                        <option value="audio">Audio Analysis</option>
                                        <option value="video">Video Analysis</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button type="submit" class="btn btn-primary w-100" id="upload-button">
                                        <i class="fas fa-cloud-upload-alt"></i> Upload
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2 text-muted small">
                                <p class="mb-0">
                                    <i class="fas fa-info-circle"></i> Files are stored temporarily and will expire after 48 hours.
                                    <br>Maximum file size: 2GB.
                                </p>
                            </div>
                        </form>
                        <div id="upload-progress" class="progress mt-3 d-none">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" aria-valuenow="0" aria-valuemin="0" 
                                 aria-valuemax="100" style="width: 0%"></div>
                        </div>
                        <div id="upload-alert" class="alert mt-3 d-none"></div>
                    </div>

                    <!-- File Listing -->
                    <div>
                        <h6 class="card-subtitle mb-3">Your Files</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="files-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Filename</th>
                                        <th>Purpose</th>
                                        <th>Type</th>
                                        <th>Size</th>
                                        <th>Uploaded</th>
                                        <th>Expires</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="files-list">
                                    <!-- Files will be loaded here via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-files-message" class="text-center text-muted py-5 d-none">
                            <i class="fas fa-file-upload fa-3x mb-3"></i>
                            <p>You haven't uploaded any files yet.</p>
                        </div>
                        <div id="loading-files" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading files...</p>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-clock"></i> Files are stored for 48 hours
                        </small>
                        <a href="{% url 'interaction:conversations' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Back to Conversations
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="delete-modal" tabindex="-1" aria-labelledby="delete-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="delete-modal-label">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete <span id="delete-filename" class="fw-bold"></span>?
                <p class="text-danger mt-2 mb-0">
                    <i class="fas fa-exclamation-triangle"></i> This action cannot be undone.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // CSRF token setup for AJAX requests
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Elements
        const filesList = document.getElementById('files-list');
        const noFilesMessage = document.getElementById('no-files-message');
        const loadingFiles = document.getElementById('loading-files');
        const fileUploadForm = document.getElementById('file-upload-form');
        const uploadProgress = document.getElementById('upload-progress');
        const progressBar = uploadProgress.querySelector('.progress-bar');
        const uploadAlert = document.getElementById('upload-alert');
        const refreshButton = document.getElementById('refresh-files');
        const deleteModal = document.getElementById('delete-modal');
        const deleteFilename = document.getElementById('delete-filename');
        const confirmDeleteButton = document.getElementById('confirm-delete');
        
        // File data storage
        let files = [];
        let fileToDelete = null;
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) {
                return bytes + ' B';
            } else if (bytes < 1024 * 1024) {
                return (bytes / 1024).toFixed(2) + ' KB';
            } else if (bytes < 1024 * 1024 * 1024) {
                return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            } else {
                return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
            }
        }
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }
        
        // Format time remaining
        function formatTimeRemaining(expirationDate) {
            if (!expirationDate) return 'N/A';
            
            const now = new Date();
            const expiration = new Date(expirationDate);
            const diffMs = expiration - now;
            
            if (diffMs <= 0) {
                return 'Expired';
            }
            
            const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            return `${diffHrs}h ${diffMins}m`;
        }
        
        // Load files from server
        function loadFiles(showRefreshing = false) {
            if (showRefreshing) {
                refreshButton.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Refreshing...';
                refreshButton.disabled = true;
            } else {
                noFilesMessage.classList.add('d-none');
                loadingFiles.classList.remove('d-none');
            }
            
            fetch('{% url "gemini_integration:file_list" %}' + (showRefreshing ? '?refresh=true' : ''), {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                files = data.files;
                renderFiles();
            })
            .catch(error => {
                console.error('Error loading files:', error);
                uploadAlert.textContent = 'Error loading files. Please try again.';
                uploadAlert.classList.remove('d-none', 'alert-success');
                uploadAlert.classList.add('alert-danger');
            })
            .finally(() => {
                loadingFiles.classList.add('d-none');
                if (showRefreshing) {
                    refreshButton.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                    refreshButton.disabled = false;
                }
            });
        }
        
        // Render files in the table
        function renderFiles() {
            filesList.innerHTML = '';
            
            if (files.length === 0) {
                noFilesMessage.classList.remove('d-none');
                return;
            }
            
            noFilesMessage.classList.add('d-none');
            
            files.forEach(file => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td class="text-nowrap">
                        <i class="fas fa-file mr-2"></i> ${file.filename}
                    </td>
                    <td>${file.purpose}</td>
                    <td>${file.mime_type}</td>
                    <td>${formatFileSize(file.bytes_size)}</td>
                    <td>${formatDate(file.created_at)}</td>
                    <td>${file.expiration_time ? formatTimeRemaining(file.expiration_time) : 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger delete-file" data-file-id="${file.id}" data-filename="${file.filename}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                filesList.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-file').forEach(button => {
                button.addEventListener('click', function() {
                    const fileId = this.dataset.fileId;
                    const filename = this.dataset.filename;
                    
                    fileToDelete = fileId;
                    deleteFilename.textContent = filename;
                    
                    const modal = new bootstrap.Modal(deleteModal);
                    modal.show();
                });
            });
        }
        
        // Handle file upload
        fileUploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('file-input');
            const purposeSelect = document.getElementById('purpose-select');
            
            if (!fileInput.files.length) {
                uploadAlert.textContent = 'Please select a file to upload.';
                uploadAlert.classList.remove('d-none', 'alert-success');
                uploadAlert.classList.add('alert-danger');
                return;
            }
            
            const file = fileInput.files[0];
            
            // Check file size (2GB limit)
            if (file.size > 2 * 1024 * 1024 * 1024) {
                uploadAlert.textContent = 'File size exceeds 2GB limit.';
                uploadAlert.classList.remove('d-none', 'alert-success');
                uploadAlert.classList.add('alert-danger');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('purpose', purposeSelect.value);
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            // Show progress bar
            uploadProgress.classList.remove('d-none');
            progressBar.style.width = '0%';
            progressBar.setAttribute('aria-valuenow', 0);
            
            // Disable upload button
            document.getElementById('upload-button').disabled = true;
            
            // Hide previous alerts
            uploadAlert.classList.add('d-none');
            
            // Create and configure XMLHttpRequest
            const xhr = new XMLHttpRequest();
            
            xhr.open('POST', '{% url "gemini_integration:file_upload" %}', true);
            
            xhr.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percentComplete + '%';
                    progressBar.setAttribute('aria-valuenow', percentComplete);
                }
            };
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    
                    uploadAlert.textContent = 'File uploaded successfully!';
                    uploadAlert.classList.remove('d-none', 'alert-danger');
                    uploadAlert.classList.add('alert-success');
                    
                    // Reset form
                    fileUploadForm.reset();
                    
                    // Reload files
                    loadFiles();
                } else {
                    let errorMessage = 'An error occurred during upload.';
                    
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.error) {
                            errorMessage = response.error;
                        }
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                    
                    uploadAlert.textContent = errorMessage;
                    uploadAlert.classList.remove('d-none', 'alert-success');
                    uploadAlert.classList.add('alert-danger');
                }
            };
            
            xhr.onerror = function() {
                uploadAlert.textContent = 'Network error occurred during upload.';
                uploadAlert.classList.remove('d-none', 'alert-success');
                uploadAlert.classList.add('alert-danger');
            };
            
            xhr.onloadend = function() {
                // Re-enable upload button
                document.getElementById('upload-button').disabled = false;
                
                // Hide progress bar after a short delay
                setTimeout(() => {
                    uploadProgress.classList.add('d-none');
                }, 1000);
            };
            
            // Send the request
            xhr.send(formData);
        });
        
        // Handle file deletion
        confirmDeleteButton.addEventListener('click', function() {
            if (!fileToDelete) return;
            
            const fileId = fileToDelete;
            const modal = bootstrap.Modal.getInstance(deleteModal);
            
            // Disable button and show loading state
            confirmDeleteButton.disabled = true;
            confirmDeleteButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...';
            
            fetch(`{% url "gemini_integration:file_delete" file_id=0 %}`.replace('0', fileId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete file');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Remove file from the list
                    files = files.filter(file => file.id !== parseInt(fileId));
                    
                    // Show success message
                    uploadAlert.textContent = 'File deleted successfully!';
                    uploadAlert.classList.remove('d-none', 'alert-danger');
                    uploadAlert.classList.add('alert-success');
                    
                    // Re-render files
                    renderFiles();
                    
                    // Close modal
                    modal.hide();
                } else {
                    throw new Error(data.error || 'Failed to delete file');
                }
            })
            .catch(error => {
                console.error('Error deleting file:', error);
                
                uploadAlert.textContent = error.message || 'Error deleting file. Please try again.';
                uploadAlert.classList.remove('d-none', 'alert-success');
                uploadAlert.classList.add('alert-danger');
                
                // Close modal
                modal.hide();
            })
            .finally(() => {
                // Reset button state
                confirmDeleteButton.disabled = false;
                confirmDeleteButton.innerHTML = 'Delete';
                
                // Reset fileToDelete
                fileToDelete = null;
            });
        });
        
        // Handle refresh button click
        refreshButton.addEventListener('click', function() {
            loadFiles(true);
        });
        
        // Load files on page load
        loadFiles();
        
        // Refresh files periodically (every 30 seconds)
        setInterval(() => {
            loadFiles();
        }, 30000);
    });
</script>
{% endblock %}
