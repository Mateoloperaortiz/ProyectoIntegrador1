{% extends 'base/base.html' %}
{% load static %}
{% load django_bootstrap5 %}

{% block title %}Speech-to-Text - InspireAI{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-microphone me-2"></i> Speech-to-Text
                    </h3>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        Transcribe audio to text using OpenAI's Whisper model. Upload an audio file or record directly from your microphone.
                    </p>
                    
                    <ul class="nav nav-tabs mb-4" id="transcriptionTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-tab-pane" type="button" role="tab" aria-controls="upload-tab-pane" aria-selected="true">
                                <i class="fas fa-upload me-2"></i> Upload File
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="record-tab" data-bs-toggle="tab" data-bs-target="#record-tab-pane" type="button" role="tab" aria-controls="record-tab-pane" aria-selected="false">
                                <i class="fas fa-microphone me-2"></i> Record Audio
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="transcriptionTabsContent">
                        <!-- File Upload Tab -->
                        <div class="tab-pane fade show active" id="upload-tab-pane" role="tabpanel" aria-labelledby="upload-tab" tabindex="0">
                            <form method="post" enctype="multipart/form-data" id="upload-form">
                                {% csrf_token %}
                                {% bootstrap_form form %}
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-file-audio me-2"></i> Transcribe Audio
                                </button>
                                <a href="{% url 'openai_integration:file_list' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-2"></i> Cancel
                                </a>
                            </form>
                        </div>
                        
                        <!-- Recording Tab -->
                        <div class="tab-pane fade" id="record-tab-pane" role="tabpanel" aria-labelledby="record-tab" tabindex="0">
                            <div class="text-center mb-4">
                                <div class="record-controls">
                                    <button id="startRecording" class="btn btn-lg btn-primary rounded-circle p-3">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                    <button id="stopRecording" class="btn btn-lg btn-danger rounded-circle p-3" style="display:none;">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                </div>
                                <p id="recordingStatus" class="mt-3 mb-0 text-muted">Click the microphone to start recording</p>
                                <div id="recordingTimer" class="mt-2 mb-4" style="display:none;">
                                    <span class="badge bg-danger px-3 py-2" style="font-size: 1rem;">
                                        <i class="fas fa-circle text-danger recording-indicator"></i>
                                        <span id="timer">00:00</span>
                                    </span>
                                </div>
                            </div>
                            
                            <div id="audioControls" style="display:none;" class="mb-4">
                                <h5>Recording Preview</h5>
                                <audio id="audioPreview" controls class="w-100 mb-3"></audio>
                                <div class="d-grid gap-2">
                                    <button id="transcribeRecording" class="btn btn-primary">
                                        <i class="fas fa-file-alt me-2"></i> Transcribe Recording
                                    </button>
                                    <button id="resetRecording" class="btn btn-outline-secondary">
                                        <i class="fas fa-redo me-2"></i> Record Again
                                    </button>
                                </div>
                            </div>
                            
                            <div id="recordingLanguageContainer" class="mb-3">
                                <label for="recordingLanguage" class="form-label">Language (optional)</label>
                                <select id="recordingLanguage" class="form-select">
                                    <option value="">Auto-detect language</option>
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="it">Italian</option>
                                    <option value="pt">Portuguese</option>
                                    <option value="nl">Dutch</option>
                                    <option value="ja">Japanese</option>
                                    <option value="ko">Korean</option>
                                    <option value="zh">Chinese</option>
                                </select>
                                <div class="form-text">Select the language of the audio for better accuracy.</div>
                            </div>
                        </div>
                    </div>
                    
                    {% if transcription %}
                        <div class="mt-4">
                            <h5 class="mb-3">Transcription Result</h5>
                            <div class="card">
                                <div class="card-body bg-light">
                                    <p class="mb-0">{{ transcription }}</p>
                                </div>
                                <div class="card-footer d-flex justify-content-end">
                                    <button id="copyTranscription" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-copy me-1"></i> Copy Text
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <div id="transcriptionResult" class="mt-4" style="display:none;">
                        <h5 class="mb-3">Transcription Result</h5>
                        <div class="card">
                            <div class="card-body bg-light">
                                <p id="transcriptionText" class="mb-0"></p>
                            </div>
                            <div class="card-footer d-flex justify-content-end">
                                <button id="copyTranscriptionResult" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-copy me-1"></i> Copy Text
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i> 
                        Supported formats: MP3, MP4, MPEG, MPGA, M4A, WAV, and WEBM.
                        Maximum file size: 25 MB.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Recording variables
        let mediaRecorder;
        let audioChunks = [];
        let recordingStartTime;
        let timerInterval;
        let audioBlob;
        
        // DOM elements
        const startRecordingBtn = document.getElementById('startRecording');
        const stopRecordingBtn = document.getElementById('stopRecording');
        const recordingStatus = document.getElementById('recordingStatus');
        const recordingTimer = document.getElementById('recordingTimer');
        const timerDisplay = document.getElementById('timer');
        const audioControls = document.getElementById('audioControls');
        const audioPreview = document.getElementById('audioPreview');
        const transcribeRecordingBtn = document.getElementById('transcribeRecording');
        const resetRecordingBtn = document.getElementById('resetRecording');
        const transcriptionResult = document.getElementById('transcriptionResult');
        const transcriptionText = document.getElementById('transcriptionText');
        const copyTranscriptionBtn = document.getElementById('copyTranscriptionResult');
        const uploadForm = document.getElementById('upload-form');
        const recordingLanguage = document.getElementById('recordingLanguage');
        
        // Start recording
        startRecordingBtn.addEventListener('click', function() {
            // Request microphone access
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        // Stop timer
                        clearInterval(timerInterval);
                        
                        // Create blob from chunks and set to audio element
                        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioPreview.src = audioUrl;
                        
                        // Show audio controls
                        audioControls.style.display = 'block';
                        recordingStatus.innerText = 'Recording completed';
                        recordingTimer.style.display = 'none';
                    };
                    
                    // Start recording
                    mediaRecorder.start();
                    
                    // Update UI
                    startRecordingBtn.style.display = 'none';
                    stopRecordingBtn.style.display = 'inline-block';
                    recordingStatus.innerText = 'Recording in progress...';
                    audioControls.style.display = 'none';
                    transcriptionResult.style.display = 'none';
                    
                    // Start timer
                    recordingStartTime = Date.now();
                    recordingTimer.style.display = 'block';
                    updateTimer();
                    timerInterval = setInterval(updateTimer, 1000);
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    recordingStatus.innerText = 'Error: ' + error.message;
                    recordingStatus.classList.add('text-danger');
                });
        });
        
        // Stop recording
        stopRecordingBtn.addEventListener('click', function() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                // Update UI
                startRecordingBtn.style.display = 'inline-block';
                stopRecordingBtn.style.display = 'none';
            }
        });
        
        // Reset recording
        resetRecordingBtn.addEventListener('click', function() {
            audioControls.style.display = 'none';
            recordingStatus.innerText = 'Click the microphone to start recording';
            audioPreview.src = '';
            audioBlob = null;
            transcriptionResult.style.display = 'none';
        });
        
        // Transcribe recorded audio
        transcribeRecordingBtn.addEventListener('click', function() {
            if (!audioBlob) {
                return;
            }
            
            // Show loading state
            transcribeRecordingBtn.disabled = true;
            transcribeRecordingBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Transcribing...';
            
            // Create form data with audio blob
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.webm');
            
            // Add language if specified
            const language = recordingLanguage.value;
            if (language) {
                formData.append('language', language);
            }
            
            // Add CSRF token
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            // Send to server
            fetch("{% url 'openai_integration:ajax_stt' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Reset button state
                transcribeRecordingBtn.disabled = false;
                transcribeRecordingBtn.innerHTML = '<i class="fas fa-file-alt me-2"></i> Transcribe Recording';
                
                if (data.success) {
                    // Show transcription
                    transcriptionText.innerText = data.transcription;
                    transcriptionResult.style.display = 'block';
                } else {
                    // Show error
                    alert('Error transcribing audio: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error transcribing audio: ' + error.message);
                
                // Reset button state
                transcribeRecordingBtn.disabled = false;
                transcribeRecordingBtn.innerHTML = '<i class="fas fa-file-alt me-2"></i> Transcribe Recording';
            });
        });
        
        // Copy transcription to clipboard
        copyTranscriptionBtn.addEventListener('click', function() {
            const text = transcriptionText.innerText;
            navigator.clipboard.writeText(text).then(() => {
                // Show feedback
                const originalText = copyTranscriptionBtn.innerHTML;
                copyTranscriptionBtn.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
                setTimeout(() => {
                    copyTranscriptionBtn.innerHTML = originalText;
                }, 2000);
            });
        });
        
        // Copy existing transcription (from server-side rendering)
        const existingCopyBtn = document.getElementById('copyTranscription');
        if (existingCopyBtn) {
            existingCopyBtn.addEventListener('click', function() {
                const transcriptionDiv = document.querySelector('.card-body.bg-light p');
                if (transcriptionDiv) {
                    const text = transcriptionDiv.innerText;
                    navigator.clipboard.writeText(text).then(() => {
                        // Show feedback
                        const originalText = existingCopyBtn.innerHTML;
                        existingCopyBtn.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
                        setTimeout(() => {
                            existingCopyBtn.innerHTML = originalText;
                        }, 2000);
                    });
                }
            });
        }
        
        // Submit form with loading state
        if (uploadForm) {
            uploadForm.addEventListener('submit', function() {
                const submitBtn = uploadForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Transcribing...';
            });
        }
        
        // Helper function to update timer display
        function updateTimer() {
            const elapsedMilliseconds = Date.now() - recordingStartTime;
            const elapsedSeconds = Math.floor(elapsedMilliseconds / 1000);
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Add CSS for recording indicator blinking
        const style = document.createElement('style');
        style.textContent = `
            @keyframes blink {
                0% { opacity: 1; }
                50% { opacity: 0.3; }
                100% { opacity: 1; }
            }
            .recording-indicator {
                animation: blink 1s infinite;
                display: inline-block;
                margin-right: 5px;
            }
        `;
        document.head.appendChild(style);
    });
</script>
{% endblock %}
