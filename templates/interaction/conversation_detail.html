{% extends 'base/base.html' %}
{% load static %}
{% load django_bootstrap5 %}

{% block title %}Conversation with {{ conversation.tool.name }} - InspireAI{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-5 fw-bold">{{ conversation.title }}</h1>
            <p class="lead">Conversation with {{ conversation.tool.name }}</p>
        </div>
        <div class="col-md-4 text-md-end">
            <a href="{% url 'interaction:conversation_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Conversations
            </a>
        </div>
    </div>
    
    <div class="row">
        <!-- Conversation Info -->
        <div class="col-lg-4 mb-4 order-lg-2">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Conversation Info</h4>
                </div>
                <div class="card-body">
                    <!-- Conversation title edit form -->
                    <form method="post" action="{% url 'interaction:update_title' conversation_id=conversation.id %}" class="mb-4">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="id_title">Conversation Title</label>
                            <div class="input-group">
                                <input type="text" name="title" value="{{ conversation.title }}" class="form-control" id="id_title">
                                <button type="submit" class="btn btn-outline-primary">Update</button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">Created on:</small>
                        <p>{{ conversation.created_at|date:"F j, Y, g:i a" }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">Last activity:</small>
                        <p>{{ conversation.updated_at|date:"F j, Y, g:i a" }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">Total messages:</small>
                        <p>{{ messages|length }}</p>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">About {{ conversation.tool.name }}</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex mb-3">
                        {% if conversation.tool.image %}
                            <img src="{{ conversation.tool.image.url }}" alt="{{ conversation.tool.name }}" class="rounded me-3" style="width: 64px; height: 64px; object-fit: cover;">
                        {% else %}
                            <img src="{% static 'images/placeholder.png' %}" alt="{{ conversation.tool.name }}" class="rounded me-3" style="width: 64px; height: 64px; object-fit: cover;">
                        {% endif %}
                        <div>
                            <h6>{{ conversation.tool.name }}</h6>
                            <span class="badge bg-primary rounded-pill">{{ conversation.tool.get_category_display }}</span>
                            <small class="d-block text-muted mt-1">By {{ conversation.tool.provider }}</small>
                        </div>
                    </div>
                    
                    <p class="small">{{ conversation.tool.description|truncatechars:150 }}</p>
                    
                    <a href="{% url 'catalog:tool_detail' conversation.tool.slug %}" class="btn btn-sm btn-outline-primary w-100">View Full Details</a>
                </div>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="col-lg-8 order-lg-1">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Chat with {{ conversation.tool.name }}</h4>
                </div>
                <div class="card-body">
                    <!-- Messages -->
                    <div class="chat-container mb-4" style="max-height: 600px; overflow-y: auto;">
                        {% if messages %}
                            <div class="chat-messages">
                                {% for message in messages %}
                                    <div class="chat-message mb-3 {% if message.is_from_user %}chat-message-user{% else %}chat-message-ai{% endif %}">
                                        <div class="card {% if message.is_from_user %}bg-primary text-white ms-auto{% else %}bg-light{% endif %}" style="max-width: 80%;">
                                            <div class="card-body py-2 px-3">
                                                <p class="mb-1">{{ message.content|linebreaksbr }}</p>
                                                <small class="{% if message.is_from_user %}text-light{% else %}text-muted{% endif %} d-block text-end">
                                                    {{ message.timestamp|date:"g:i a" }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <p class="mb-0">Start your conversation with {{ conversation.tool.name }} below!</p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Message Form -->
                    <form method="post" action="{% url 'interaction:send_message' conversation_id=conversation.id %}" id="message-form">
                        {% csrf_token %}
                        {% bootstrap_form message_form %}
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-1"></i> Send
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js" integrity="sha512-Tn2m0TIpgVyTzzvmxLNuqbSJH3JP8jm+Cy3hvHrW7ndTDcJ1w5mBiksqDBb8GpE2ksktFvDB/ykZ0mDpsZj20w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Scroll to bottom of chat container
        const chatContainer = document.querySelector('.chat-container');
        if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Focus on message input
        const messageInput = document.querySelector('#id_content');
        if (messageInput) {
            messageInput.focus();
        }
    });
</script>
{% endblock %}